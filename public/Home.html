<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mabel Statement | Browse</title>
  <link rel="stylesheet" href="Styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    .cart-badge {
      background: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      position: absolute;
      top: -8px;
      right: -8px;
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
    }
    .toast {
      background: #333;
      color: white;
      padding: 10px 20px;
      margin-bottom: 10px;
      border-radius: 4px;
      animation: fadeout 4s forwards;
    }
    @keyframes fadeout {
      0% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-20px); }
    }

    .card span[style*="-"]:not([style*="line-through"]) {
      box-shadow: 0 2px 6px rgba(0,0,0,.25);


    }
    .discount-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: #e53935;
      color: #fff;
      font-size: 0.8rem;
      padding: 2px 6px;
      border-radius: 4px;
      z-index: 10; /* make sure it stays above the images */
}

    .card img {
  width: 100%;
  transition: opacity 0.3s ease;
  position: absolute;
  top: 0;
  left: 0;
  cursor: pointer;
}

.card .img-wrapper {
  position: relative;
  width: 100%;
  padding-top: 200%; /* adjust for aspect ratio */
  overflow: hidden;
}

.card .img-wrapper img.hover {
  opacity: 0;
}

.card .img-wrapper:hover img.hover {
  opacity: 1;
}

.card .img-wrapper:hover img.main {
  opacity: 0;
}

  </style>
</head>
<body>
  <header class="header">
    <a href="#" class="logo"><h1>Mabel Statement</h1></a>
    <div class="icon"><div class="fa fa-bars" id="menu-btn"></div>
    </div>
    <nav class="navbar">
      <a href="#home">Home</a>
      <a href="#offers">What's New</a>
      <a href="#browse">Browse</a>
      <a href="#about">Visit Us</a> 
      <a class="category-toggle">Categories â–¸</a>
      <a id="logoutBtn" >Logout</a>

      <div id="categoryOverlay" class="category-overlay">
        <div class="category-sidebar">
          <div class="close-category">&times;</div>
          <h3>Categories</h3>
          <a href="category.html">All Products</a>
          <a href="category.html?cat=Mini_Dress">Mini-Dresses</a>
          <a href="category.html?cat=Midi_Dress">Midi-Dresses</a>
          <a href="category.html?cat=Maxi_Dress">Maxi-Dresses</a>
          <a href="category.html?cat=Perfume">Perfumes</a>
          <a href="category.html?cat=Accessory">Accessories</a>
        </div>
    </nav>
    <div class="icons">
      <div class="fa fa-search" id="search-btn"></div>
      <a href="login.html"><div class="fa fa-user" aria-hidden="true"></div></a>
      
      <div class="fa fa-shopping-bag" id="cart-btn" style="position: relative; cursor: pointer;">
  <span id="cart-badge" class="cart-badge" style="display:none;">0</span>
</div>

    </div>
    <form class="search-form" id="searchForm" action="category.html" method="get">
      <input type="text" name="search" placeholder="Search products..." required>
      <button class="btn" type="submit">Search</button>
    </form>
    
    <p id="userDisplayName" style="font-size: 2rem; color: var(--main-color); position: fixed; top: 20px; left: 20px;">Welcome, Guest</p>
  
  </header>

  <div id="toast-container" class="toast-container"></div>

  <section class="home" id="home">
    <div class="content">
      <h3>Mabel Statement</h3>
      <a href="#offers" class="btn">shop now</a>
    </div>
  </section>

  <section>
    <h1 class="heading"><span>Special</span> offers</h1>
    <div id="offers" class="product-grid"></div>
  </section>

  <section>
    <h1 class="heading">Browse All Products</h1>
    <section id="filters" class="filters">
      <select id="categoryFilter"><option value="">All categories</option></select>
      <input id="minPrice" type="number" placeholder="Min KES" min="0" />
      <input id="maxPrice" type="number" placeholder="Max KES" min="0" />
      <label><input type="checkbox" id="offerOnly" /> On offer</label>
      <button id="applyFilters" class="btn">Apply</button>
    </section>
    <div id="browse" class="product-grid">Loading products...</div>
  </section>

  <section class="about" id="about">
    <h1 class="heading"><span>Visit</span> us</h1>
    <div class="row">
<iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3988.8181058834393!2d36.82310503291125!3d-1.282970609935422!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x182f11004419bdf3%3A0xebb9ba3c4a0707f9!2sSawa%20mall!5e0!3m2!1sen!2ske!4v1749663098801!5m2!1sen!2ske" width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      <div class="content">
        <h3>Our Store</h3>
        <p class="fa fa-map-marker"> location</p>
        <p>Visit us At Sawa mall</p>
        <p> Store Number m26</p>
        <h3>Contact us</h3>
        <p class="fab fa-whatsapp"> whatsapp</p> 
          <p>+254 748 398646</p>
      </div>
    </div>
  </section>

  <section class="footer">
    <div class="share">
      <a href="#" class="fa-brands fa-tiktok"></a>
      <a href="#" class="fab fa-instagram"></a>
      </div>
    <div class="links">
      <a href="#home">home</a>
      <a href="#offers">What's New</a>
      <a href="#about">Visit us</a>
    </div>
    <div class="credit">Mabel <span>Statement</span> | all rights reserved</div>
  </section>

  <script>
  // ------------------------------
  // ðŸ” CART BADGE
  // ------------------------------
  function updateCartBadge() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const totalQty = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
    const badge = document.getElementById('cart-badge');
    if (badge) {
      badge.textContent = totalQty > 0 ? totalQty : '';
      badge.style.display = totalQty > 0 ? 'inline' : 'none';
    }
  }

  // ------------------------------
  // âŒ MODAL CLOSE LOGIC
  // ------------------------------
  function setupModalCloseListeners() {
    const closeBtn = document.querySelector('.close');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        document.getElementById('productModal').style.display = 'none';
      });
    }

    window.addEventListener('click', (e) => {
      const modal = document.getElementById('productModal');
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  }

  // ------------------------------
  // ðŸ“¦ MAIN LOGIC
  // ------------------------------
  document.addEventListener('DOMContentLoaded', () => {
    const API = 'https://clothing-store-demo.onrender.com/api/products';

    const offersDiv = document.getElementById('offers');
    const browseDiv = document.getElementById('browse');
    const catSelect = document.getElementById('categoryFilter');
    const minIn = document.getElementById('minPrice');
    const maxIn = document.getElementById('maxPrice');
    const offerChk = document.getElementById('offerOnly');
    const applyBtn = document.getElementById('applyFilters');

    document.getElementById('cart-btn').addEventListener('click', async () => {
      try {
        const res = await fetch('https://clothing-store-demo.onrender.com/api/users/me', {
          credentials: 'include'
        });

        if (!res.ok) throw new Error('Not logged in');

        window.location.href = 'checkout.html';
      } catch (err) {
        localStorage.setItem('redirectAfterLogin', 'checkout.html');
        window.location.href = 'login.html';
      }
    });

    // ðŸ” Auth Check + Display Name
    checkLogin();

    async function checkLogin() {
      try {
        const res = await fetch('https://clothing-store-demo.onrender.com/api/users/me', {
          method: 'GET',
          credentials: 'include'
        });

        if (!res.ok) throw new Error('Unauthorized');
        const data = await res.json();
        document.getElementById('userDisplayName').textContent = data.name;
      } catch (err) {
        window.location.href = 'login.html';
      }
    }

    // ðŸšª Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('https://clothing-store-demo.onrender.com/api/users/logout', {
        method: 'POST',
        credentials: 'include'
      });

      window.location.href = 'login.html';
    });

    // ðŸŒ Init Products
    let allProducts = [];
    init();

    async function init() {
      allProducts = await fetchProducts();
      populateCategories(allProducts);
      render(allProducts);
    }

    applyBtn.addEventListener('click', () => {
      let filtered = [...allProducts];

      if (catSelect.value)
        filtered = filtered.filter(p => p.category === catSelect.value);

      if (minIn.value)
        filtered = filtered.filter(p => Number(p.price) >= Number(minIn.value));

      if (maxIn.value)
        filtered = filtered.filter(p => Number(p.price) <= Number(maxIn.value));

      if (offerChk.checked)
        filtered = filtered.filter(p => p.isOffer);

      render(filtered);
    });

    async function fetchProducts() {
      const res = await fetch(API);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function populateCategories(products) {
      const cats = [...new Set(products.map(p => p.category).filter(Boolean))];
      catSelect.innerHTML = '<option value="">All categories</option>';
      cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = c;
        catSelect.appendChild(opt);
      });
    }

    function render(allProducts) {
  offersDiv.innerHTML = '';
  browseDiv.innerHTML = '';

  // ðŸ”¸ Filter special offers only
  const realOffers = allProducts.filter(p =>
    p.isOffer === true && typeof p.discount === 'number' && p.discount > 0
  );

  // ðŸ”¸ Everything else goes to browse
  const nonOffers = allProducts.filter(p =>
    !p.isOffer || p.discount <= 0 || typeof p.discount !== 'number'
  );

  // Render Special Offers
  if (realOffers.length) {
    realOffers.forEach(p => offersDiv.appendChild(makeCard(p)));
  } else {
    offersDiv.textContent = 'Currently no offers.';
  }

  // Render Browse Products
  if (nonOffers.length) {
    nonOffers.forEach(p => browseDiv.appendChild(makeCard(p)));
  } else {
    browseDiv.textContent = 'No products found.';
  }

  attachCartListeners();
  updateCartBadge();
}







    function makeCard(p) {
  const card = document.createElement('div');
  card.className = 'card';
  card.style.cursor = 'pointer';

  const baseURL = 'https://clothing-store-demo.onrender.com';

  const mainImg = p.imageUrl
    ? (p.imageUrl.startsWith('http') ? p.imageUrl.replace('http://', 'https://') : `${baseURL}${p.imageUrl}`)
    : 'fallback.jpg';  // ðŸ” fallback image

  const hoverImg = p.hoverImageUrl
    ? (p.hoverImageUrl.startsWith('http') ? p.hoverImageUrl.replace('http://', 'https://') : `${baseURL}${p.hoverImageUrl}`)
    : mainImg;

  const isOffer = p.isOffer && Number(p.discount) > 0;
  const discount = Number(p.discount) || 0;
  const priceOld = Number(p.price);
  const priceNew = (priceOld * (100 - discount) / 100).toFixed(2);

  card.innerHTML = `
    <div class="img-wrapper-container" style="position:relative">
      ${isOffer ? `<span class="discount-badge">-${discount}%</span>` : ''}
      <div class="img-wrapper">
        <img src="${mainImg}" alt="${p.name}" class="main">
        <img src="${hoverImg}" alt="${p.name}" class="hover">
      </div>
    </div>
    <h3>${p.name}</h3>
    ${isOffer
      ? `<p><span style="text-decoration:line-through;color:#888;">KES ${priceOld.toLocaleString()}</span><br><strong style="color:#ce8e1a;">KES ${priceNew}</strong></p>`
      : `<p>KES ${priceOld.toLocaleString()}</p>`}
    <small>In stock: ${p.stock}</small>
    <button class="add-to-cart-btn"
            data-id="${p._id}"
            data-name="${p.name}"
            data-price="${isOffer ? priceNew : priceOld}"
            data-stock="${p.stock}"
            data-img="${mainImg}">
      Add to Cart
    </button>
  `;

  // âœ… Make the entire card (except button) trigger modal
  card.addEventListener('click', (e) => {
    if (e.target.classList.contains('add-to-cart-btn')) return;
    const modal = document.getElementById('productModal');
    const body = document.getElementById('modal-body');
    modal.style.display = 'block';
    body.innerHTML = `
      <h2>${p.name}</h2>
      <img src="${mainImg}" alt="${p.name}" style="width:100%;border-radius:10px;max-height:300px;object-fit:cover;margin-bottom:1rem;">
      <p><strong>Price:</strong> ${isOffer
        ? `KES <del>${priceOld}</del> <span style="color:#ce8e1a;">KES ${priceNew}</span>`
        : `KES ${priceOld}`}</p>
      <p><strong>Category:</strong> ${p.category}</p>
      <p><strong>In stock:</strong> ${p.stock}</p>
      ${p.description ? `<p>${p.description}</p>` : ''}
    `;
  });

  return card;
}


    function attachCartListeners() {
      document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const name = btn.dataset.name;
          const price = parseFloat(btn.dataset.price);
          const stock = parseInt(btn.dataset.stock);
          const img = btn.dataset.img;

          let cart = JSON.parse(localStorage.getItem('cart') || '[]');
          let item = cart.find(i => i.id === id);

          if (item) {
            if (item.quantity < stock) {
              item.quantity++;
              showToast(`Added another "${name}"`);
            } else {
              showToast(`Only ${stock} left in stock.`);
              return;
            }
          } else {
            cart.push({ id, name, price, stock, quantity: 1, img });
            showToast(`Added "${name}" to cart`);
          }

          localStorage.setItem('cart', JSON.stringify(cart));
          updateCartBadge();
        });
      });
    }

    function showToast(msg) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      document.getElementById('toast-container').appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    setupModalCloseListeners();
    updateCartBadge();
  });
</script>


  <script src="script.js"></script>
  <div id="productModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="modal-body">Loading...</div>
           
  </div>
</div>
</body>
</html>