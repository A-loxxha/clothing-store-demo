<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Checkout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="Styles.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.7/css/all.css" />
  <style>
    :root {
      --main-color: #ceb974;
      --black: #161515d5;
      --bg: #00000038;
      --hover-black: #00000036;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f5f5;
      margin-top: 15rem;
      padding: 20px;
    }

    h2 {
      font-size: 3rem;
      font-family: 'Playfair Display', serif;
      padding: 1.5rem;
      color: var(--main-color);
      text-align: center;
    }

    .cart-items {
  max-width: 800px;
  margin: 60px auto 30px;
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
}

.cart-items h3 {
  color: var(--main-color);
  font-size: 2rem;
  margin-bottom: 20px;
}

.cart-item {
  display: flex;
  gap: 20px;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid #ddd;
}

.cart-item img {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 10px;
  border: 1px solid #eee;
}

.cart-item div {
  flex: 1;
  font-size: 1rem;
  color: #333;
}

.cart-item strong {
  font-size: 1.2rem;
  color: #000;
}

.cart-item button {
  padding: 4px 10px;
  border: none;
  background-color: var(--main-color);
  color: #fff;
  font-size: 1rem;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.3s;
}

.cart-item button:hover {
  background-color: var(--sec-main-color);
}

.cart-item span {
  font-size: 1.1rem;
  font-weight: 500;
  color: #000;
}

.cart-item .remove-btn {
  margin-top: 10px;
  background: none;
  color: red;
  border: none;
  cursor: pointer;
  font-size: 0.9rem;
  padding: 0;
  transition: color 0.3s;
}

.cart-item .remove-btn:hover {
  color: darkred;
  text-decoration: underline;
}

.cart-total {
  text-align: right;
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--black);
  margin-top: 20px;
  border-top: 1px solid #ddd;
  padding-top: 20px;
}

  </style>
</head>
<body>

  <!-- Cart Items -->
  <div class="cart-items">
    <h2>Your Cart</h2>
    <div id="cart-items-container">Loading cart...</div>
  </div>

  <!-- Checkout Form -->
  <div class="checkout-container">
    <h2>Checkout</h2>
    <form id="checkout-form">
      <div>
        <label>Full Name</label>
        <input type="text" id="fullName" required />
      </div>
      <div>
        <label>Address</label>
        <input type="text" id="address" required />
      </div>
      <div>
        <label>City</label>
        <input type="text" id="city" required />
      </div>
      <div>
        <label>Postal Code</label>
        <input type="text" id="postal" required />
      </div>
      <div>
        <label>Country</label>
        <select id="country" required>
          <option value="">Select Country</option>
          <option>Kenya</option>
          <option>Uganda</option>
          <option>Tanzania</option>
        </select>
      </div>
      <div>
        <label>Delivery Area (within Nairobi)</label>
        <input type="text" id="deliveryArea" placeholder="e.g. CBD, Westlands" required />
      </div>

      <div class="payment-methods">
        <label><input type="radio" name="payment_method" value="mpesa" checked /> M‑Pesa</label>
        <label><input type="radio" name="payment_method" value="card" /> Bank Card</label>
      </div>

      <div class="mpesa-field" id="mpesa-field">
        <label>M‑Pesa Phone Number</label>
        <input type="tel" id="mpesaPhone" placeholder="07XXXXXXXX" pattern="07\d{8}" />
      </div>

      <button class="btn" type="submit">Place Order</button>
    </form>
  </div>

  <script>
    const API_BASE = 'https://clothing-store-demo.onrender.com';
    const token = localStorage.getItem('token');

    if (!token) {
      localStorage.setItem('redirectAfterLogin', 'checkout.html');
      window.location.href = 'login.html';
    }

    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const mpesaField = document.getElementById('mpesa-field');
    const paymentRadios = document.getElementsByName('payment_method');

    paymentRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        mpesaField.style.display = radio.value === 'mpesa' && radio.checked ? 'block' : 'none';
      });
    });

    function renderCart() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];

  function updateCartStorage() {
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
  }

  function changeQuantity(index, delta) {
    const item = cart[index];
    const maxQty = item.inStock || 10; // fallback to 10 if no stock field

    item.quantity = Math.min(Math.max(1, item.quantity + delta), maxQty);
    updateCartStorage();
  }

  function removeItem(index) {
    cart.splice(index, 1);
    updateCartStorage();
  }

  function renderCart() {
    const container = document.getElementById('cart-items-container');
    container.innerHTML = '';

    if (cart.length === 0) {
      container.innerHTML = '<p>Your cart is empty.</p>';
      return;
    }

    let total = 0;
    cart.forEach((item, i) => {
      total += item.price * item.quantity;

      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
  <img src="${item.img}" alt="${item.name}" />
  <div>
    <strong>${item.name}</strong><br/>
    Price: KES ${item.price.toLocaleString()}<br/>
    Quantity:
    <button onclick="changeQuantity(${i}, -1)">−</button>
    <span>${item.quantity}</span>
    <button onclick="changeQuantity(${i}, 1)">+</button><br/>
    <button class="remove-btn" onclick="removeItem(${i})">Remove</button>
  </div>
`;

      container.appendChild(div);
    });

    const totalDiv = document.createElement('div');
    totalDiv.className = 'cart-total';
    totalDiv.textContent = `Total: KES ${total.toFixed(2)}`;
    container.appendChild(totalDiv);
  }

  renderCart();
}


    document.getElementById('checkout-form').addEventListener('submit', async e => {
      e.preventDefault();
      const form = e.target;
      const paymentMethod = [...paymentRadios].find(r => r.checked)?.value;

      const shipping = {
        name: form.fullName.value,
        address: form.address.value,
        city: form.city.value,
        postal: form.postal.value,
        country: form.country.value,
        area: form.deliveryArea.value
      };

      const totalAmount = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

      if (paymentMethod === 'mpesa') {
        let phone = form.mpesaPhone.value.trim();
        if (!/^07\d{8}$/.test(phone)) return alert('Enter a valid Safaricom number.');
        phone = phone.replace(/^0/, '254');

        try {
          const res = await fetch(`${API_BASE}/api/pesapal/mpesa`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({ phone, amount: totalAmount, cart, shipping })
          });

          const data = await res.json();
          if (data.success) {
            alert('STK Push sent! Check your phone.');
            localStorage.removeItem('cart');
            window.location.href = 'thank-you.html';
          } else {
            alert('Payment initiation failed.');
          }
        } catch (err) {
          alert('Server error. Try again.');
          console.error(err);
        }

      } else if (paymentMethod === 'card') {
        try {
          const res = await fetch(`${API_BASE}/api/pesapal/initiate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({ amount: totalAmount, cart, shipping })
          });

          const data = await res.json();
          if (data.redirect_url) {
            window.location.href = data.redirect_url;
          } else {
            alert('Card payment failed to initialize.');
          }
        } catch (err) {
          alert('Server error. Try again.');
          console.error(err);
        }
      }
    });

    renderCart();
  </script>
</body>
</html>
